#!/bin/bash
#
# KAS Filesync Launcher
# Starts the menubar app with proper environment setup
#

SUPPORT_DIR="$HOME/Library/Application Support/KAS Filesync"
LOG_FILE="$SUPPORT_DIR/kas-filesync-launcher.log"

# Ensure support directory exists
mkdir -p "$SUPPORT_DIR"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG_FILE"
}

log "=== KAS Filesync starting ==="

# Setup PATH for Homebrew (both Intel and Apple Silicon) and Python user bin
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$HOME/Library/Python/3.13/bin:$HOME/Library/Python/3.12/bin:$HOME/Library/Python/3.11/bin:$PATH"

# Find Python3
PYTHON3=""
for p in /opt/homebrew/bin/python3 /usr/local/bin/python3 /usr/bin/python3 /Library/Frameworks/Python.framework/Versions/Current/bin/python3; do
    if [ -x "$p" ]; then
        PYTHON3="$p"
        break
    fi
done

if [ -z "$PYTHON3" ]; then
    PYTHON3=$(command -v python3 2>/dev/null)
fi

if [ -z "$PYTHON3" ]; then
    log "ERROR: Python 3 not found"
    osascript -e 'display alert "KAS Filesync" message "Python 3 nicht gefunden. Bitte installieren Sie Python 3."'
    exit 1
fi

log "Using Python: $PYTHON3"

# Get Python user site-packages and add to PYTHONPATH
USER_SITE=$("$PYTHON3" -m site --user-site 2>/dev/null)
if [ -n "$USER_SITE" ]; then
    export PYTHONPATH="${USER_SITE}${PYTHONPATH:+:$PYTHONPATH}"
    log "User site-packages: $USER_SITE"
fi

# Also add common user site-packages paths
PY_VERSION=$("$PYTHON3" -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>/dev/null)
if [ -n "$PY_VERSION" ]; then
    USER_PKG_DIR="$HOME/Library/Python/$PY_VERSION/lib/python/site-packages"
    if [ -d "$USER_PKG_DIR" ]; then
        export PYTHONPATH="${USER_PKG_DIR}${PYTHONPATH:+:$PYTHONPATH}"
        log "Added user packages: $USER_PKG_DIR"
    fi
fi

log "PYTHONPATH: $PYTHONPATH"

# Check if rumps is importable
if ! "$PYTHON3" -c "import rumps" 2>/dev/null; then
    log "rumps not found, attempting install..."
    "$PYTHON3" -m pip install --user --break-system-packages rumps >> "$LOG_FILE" 2>&1 \
        || "$PYTHON3" -m pip install --user rumps >> "$LOG_FILE" 2>&1

    # Re-check after install
    if ! "$PYTHON3" -c "import rumps" 2>/dev/null; then
        log "ERROR: rumps still not importable after install"
        osascript -e 'display alert "KAS Filesync" message "Konnte rumps nicht laden. Bitte im Terminal ausfÃ¼hren: pip3 install rumps"'
        exit 1
    fi
    log "rumps installed successfully"
else
    log "rumps already available"
fi

# Check if menubar app is already running
if pgrep -f "sync-menubar.py" > /dev/null; then
    log "Menubar app already running"
else
    log "Starting menubar app..."
    "$PYTHON3" "$SUPPORT_DIR/sync-menubar.py" >> "$LOG_FILE" 2>&1 &
    log "Menubar app started with PID $!"
fi

log "=== Launcher finished ==="
